# GitHub Dashboard Tilt Configuration
# This file orchestrates all services needed for the GitHub Dashboard development environment
# Force reload: 2025-01-03 23:50

# Load environment variables
load('ext://helm_resource_apply', 'helm_resource_apply')
load('ext://restart_process', 'restart_process')

# Database Services (PostgreSQL + PostGraphile)
docker_compose('database', 'docker-compose.yml', force_update=True)

# Auto-enable PostGraphile (Best Practice Permanent Fix)
# This ensures PostGraphile is always enabled when Tilt starts
local_resource(
    'postgraphile-enabler',
    cmd='sleep 3 && TILT_PORT=${TILT_PORT:-10360} tilt enable postgraphile && echo "âœ… PostGraphile enabled successfully"',
    deps=[],
    resource_deps=['database'],
    labels=['database', 'postgraphile', 'auto-enable'],
    auto_init=True,
    trigger_mode=TRIGGER_MODE_MANUAL
)

# GitHub Dashboard API Service
local_resource(
    'github-dashboard-api',
    serve_cmd='cd packages/github-dashboard/api && npm run start:dev',
    deps=['packages/github-dashboard/api'],
    resource_deps=['database'],
    labels=['api', 'nestjs', 'backend'],
    env={'DATABASE_URL': 'postgresql://postgres:password@localhost:5432/github_dashboard', 'PORT': '3001'}
)

# GitHub Dashboard Web Service  
local_resource(
    'github-dashboard-web',
    serve_cmd='cd packages/github-dashboard/web && npm run start',
    deps=['packages/github-dashboard/web'],
    resource_deps=['github-dashboard-api'],
    labels=['web', 'react', 'frontend'],
    env={'VITE_API_URL': 'http://localhost:3001/api'}
)

# Database Migration Service (runs once on startup)
local_resource(
    'db-migrate',
    cmd='cd packages/github-dashboard/api && npm run db:migrate',
    deps=['packages/github-dashboard/api'],
    resource_deps=['database'],
    labels=['database', 'migration'],
    auto_init=True,
    trigger_mode=TRIGGER_MODE_MANUAL
)
